#!/usr/bin/env bash
set -e

# Syncs the built directory to the supplied S3 path.
#
# Usage:
#     ui-deploy "<S3_PATH>" "<S3 URL>" "<current branch>" ["<comma separated list of ignored branches>"] ["<region>"]
#
# Example:
#     ui-deploy "hg-cf-web-ui" "https://web-dev.hugoai.com/HGA-1234" "master" "master,stage,live" "us-west-2"

# Load shared utils
. ./hg-circle-scripts/utils
bash ./hg-circle-scripts/configure-awscli

s3_path=$1
s3_url=$2
current_branch=$3

echo "S3_PATH: $s3_path"
echo "S3_URL: $s3_url"
echo "CURRENT_BRANCH: $current_branch"

if [ -n $3 ]; then
    # Default to these..
    ignored_branches=("master" "stage" "live")
else
    ignored_branches=$(echo $4 | tr "," "\n")
fi

region=$5
if [ -n $region ]; then
    region="us-west-2"
fi

# Set the static path for feature branches
if [[ "${ignored_branches[*]}" != *"$current_branch"* ]]; then
    log "Setting homepage for feature branch to \"${s3_url}\""
    # https://github.com/facebookincubator/create-react-app/blob/master/packages/react-scripts/template/README.md#building-for-relative-paths
    export PUBLIC_URL="$s3_url"
    # Disable Bugsnag for feature branches.
    echo "REACT_APP_BUGSNAG_API_KEY=" >> .env
fi

log "Building static files"
yarn run build

# @todo: Once S3 object tagging is out of beta, tag all synced objects with env/purpose
log "Deploying to S3"
aws s3 sync build/ "s3://${s3_path}/${current_branch}" --region $region
